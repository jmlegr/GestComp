{% extends "base.html" %}
{% block title %} GestComp {% endblock %}
{% block branding %}<h1 id="site-name">Gestion de compétences - G. Gironde </h1>{% endblock %}
{% block nav-global %}{% endblock %}

{% block javascripts %}
<script>
	var loginForm1 = { xtype: 'form',
		id: 'login-form',
		bodyStyle: 'padding:15px;background:transparent',
		border: false,
		url:'ext_login',
		items: [{
			xtype: 'box',
			autoEl: { tag: 'div',
				html: '<div > <img src="/smedia/images/schemacompetence.png" style="width:128px;" />Veuillez vous identifier...</div>'}
				},
			{ xtype: 'textfield', id: 'login-user',
			fieldLabel: 'Utilisateur',name:'username',
			allowBlank: false
			},
			{ xtype: 'textfield', id: 'login-pwd',
			fieldLabel: 'Mot de passe',name: 'password',
			inputType: 'password',allowBlank: false
			}],
			buttons: [{
				text: 'Login',
				handler: function() {
					Ext.getCmp('login-form').getForm().submit();
					}
				},
				{
				text: 'Cancel',
				handler: function() {
					win.hide();
					}
				}]
			}

      Ext.onReady(function() {
	  	LoginForm = Ext.extend(Ext.FormPanel, {
    labelAlign: 'right'
    ,labelWidth: 75
    ,title: 'Veuillez vous identifier'
    ,xtype: 'form'
    ,initComponent:function() {
        Ext.apply(this, {
            buttons:[
				{% if user.is_authenticated %}
				new Ext.Button({
                    handler: function() {window.location='logout'}
                    ,scope: this
                    ,text: 'Deconnexion'
                }),
				new Ext.Button({
                    handler: this.retour
                    ,scope: this
                    ,text: 'Annuler'
                }),
				{% endif %} 
                new Ext.Button({
                    handler: this.authSubmit
                    ,scope: this
                    ,text: 'Connexion'
                })
            ]
            ,items:[
                new Ext.form.TextField({
                    fieldLabel: 'Utilisateur'
                    ,name: 'username'
					,allowBlank:false
                    ,width: 100
                })
                ,new Ext.form.TextField({
                    fieldLabel: 'Mot de passe'
                    ,name: 'password',
					inputType: 'password'
					,allowBlank:false
                    ,showCapsWarning: true
                    ,showStrengthMeter: false
                    ,width: 100
                })
            ],
			
        });

       LoginForm.superclass.initComponent.apply(this, arguments);

        if (this.initialConfig.handler && this.initialConfig.scope){
            //this.form.on('actioncomplete', this.initialConfig.handler, this.initialConfig.scope);
            this.form.on('actionfailed', this.initialConfig.handler, this.initialConfig.scope);
        }
    }
    ,authSubmit: function(){
        this.form.submit({
            clientValidation: false
            ,method: 'POST'
            ,url:'/gestcomp/ext_login/',
			success: function(f,a) {console.log('ok ca marche',f,a); 
					//window.location='{{test}}'},
					console.log(a)
					window.location=a.result.text['lien']},
			failure: function(f,a) {console.log('echec',f,a)}
	       });
    }
});
		Ext.QuickTips.init();
		l=new LoginForm()
		/*
		new Ext.Window({
				//applyTo : "ici",
				closable : false,
				modal : true,
				width : 300,
				autoHeight : true,
				minimizable : false,
				resizable : false,
				draggable : false,
				shadowOffset : 8,
				id : "login_window",
				items: [new LoginForm()]
			}).show();
		 */
		 win = new Ext.Window({
			layout: 'form',
			width: 340,
			modal : true,
			autoHeight: true,
			closeAction: 'hide',
			items: [loginForm1]
			});
		win.show();

	  });
</script>
{% endblock %}
{% block content %}
<h1 style="text-align:center;">Gestion de compétence SEGPA G.Gironde</h1>
{% if user.is_authenticated %}
	{{user.username}} ({{user.first_name}} {{user.last_name}} connecté)
{% endif %}
<div id='ici'></div>
{% endblock %}